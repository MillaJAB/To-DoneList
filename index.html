<!DOCTYPE html>
<html lang="en">
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<style>
	table, th, td {
    	border: 1px solid black;
    	border-collapse: collapse;
	}
	th, td {
    	padding: 3px 10px 7px 10px;
	}
	.centerColumn {
		text-align: center;
	}

	input {
		margin-top: 10px;
	}
	button {
		margin-top: 10px;
	}
	form {
		border-style: solid;
		margin-top: 10px;
		width: 300px;
		padding: 10px;
		padding-left: 25px;
	}
	img {
		margin-top: 6px;
	}
	#error {
		color: red;
		margin-top: 5px;
		display: none;
	}
	</style>
</head>

<body>

	<table id="taskTable" class="centerColumn">
  		<tr>
    		<th>Priority</th>
    		<th>Project</th>
    		<th>Task</th>
    		<th>Due</th>
    		<th>Time Est</th>
    		<th>Complete?</th>
  		</tr>
	</table>

<div id="error">Please fill out all the fields. It's okay to estimate.</div>

<form>
	Project*:
	<input id="projectField" type="text" name="Priority"><br>
	Task*:
	<input id="taskField" type="text" name="Task"><br>
	Priority*:
	<input id="radioBtn1" type="radio" name="priority" value="1"> 1
	<input id="radioBtn2" type="radio" name="priority" value="2"> 2
	<input id="radioBtn3" type="radio" name="priority" value="3"> 3
	<input id="radioBtn4" type="radio" name="priority" value="4"> 4<br>
	Due Date:
	<input id="datePicker" type="date" name="dueDate"><br>
	Time Estimate:
	<input id="timeEstimate" type="text" name="timeEst">

</form>
<button onclick="setThings()">Submit</button>

<p>Click the button to sort the table alphabetically, by name:</p>
<p><button onclick="sortTable()">Sort</button></p>

</body>
</html>

<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAF_vhCFAmopW6O6-nsbxpT9EAx1wJVIjI",
    authDomain: "todonelist-5df2e.firebaseapp.com",
    databaseURL: "https://todonelist-5df2e.firebaseio.com",
    projectId: "todonelist-5df2e",
    storageBucket: "",
    messagingSenderId: "81191745304"
  };
  firebase.initializeApp(config);

var taskDataRef = firebase.database().ref("tasks").orderByChild('priority');
taskDataRef.once("value")
	.then(function(snapshot) {
		snapshot.forEach(function(childSnapshot) {
			var key = childSnapshot.key;
			var childData = childSnapshot.val();

			var priority_val = childSnapshot.val().priority;
			var project_val = childSnapshot.val().project;
			var task_val = childSnapshot.val().taskName;
			var due_val = childSnapshot.val().dueDate;
			var est_val = childSnapshot.val().timeEstimate;
			createRow(priority_val, project_val, task_val, due_val, est_val);
		})
	})

</script>

<script>
	var numRows = 0;
	// Get a reference to the database service
	var database = firebase.database();

	function writeNewTask(taskName, priority, project, dueDate, timeEstimate) {
  		firebase.database().ref('tasks/' + taskName).set({
  			 priority: priority, 
   			 project: project,
    		 taskName: taskName,
   			 dueDate : dueDate,
   			 timeEstimate: timeEstimate
 	 	});
	}

	function setThings() {
		var taskText = document.getElementById("taskField").value;
		var projectText = document.getElementById("projectField").value;
		var datePicked = document.getElementById("datePicker").value;
		var timeEstimate = document.getElementById("timeEstimate").value;
		var priorityPicked = checkRadioButtons();
		if (taskText == "" || projectText == "" || priorityPicked == null) {
			document.getElementById("error").style.display = "block";
		} else {
			writeNewTask(taskText, priorityPicked, projectText, datePicked, timeEstimate)
			clearFields();
			window.location.reload(); // Need better way to dynamically add rows without reloading the page completely
		}
	}

	function clearFields() {
		document.getElementById("projectField").value = "";
		document.getElementById("taskField").value = "";
		document.getElementById("datePicker").value = "";
		document.getElementById("timeEstimate").value = "";
		for (var i = 1; i <= 4; i++) {
			document.getElementById("radioBtn" + i).checked = false;
		}
	}

	function checkRadioButtons() {
		for (var i = 1; i <= 4; i++) {
			if (document.getElementById("radioBtn" + i).checked) {
				return document.getElementById("radioBtn" + i).value;
			}
		}
	}

	function createRow(priority, project, task, due, est) {
		var table = document.getElementById("taskTable");
		var row = table.insertRow(-1);
		var cell1 = row.insertCell(0);
		var cell2 = row.insertCell(1);
		var cell3 = row.insertCell(2);
		var cell4 = row.insertCell(3);
		var cell5 = row.insertCell(4);
		var cell6 = row.insertCell(5);
		cell1.innerHTML = priority;
		cell2.innerHTML = project;
		cell3.innerHTML = task;
		cell4.innerHTML = due;
		cell5.innerHTML = est;
		var check = document.createElement("img");
		check.src = "uncheckedBox.png";
		check.onclick = function() {
			check.src = "checkedBox.png";
			removeFromDatabase(checkedRow());
			document.getElementById("taskTable").deleteRow(checkedRow());
		}
		cell6.appendChild(check);
		numRows++;
	}

	function checkedRow() {
		for (var i = 1; i <= numRows; i++) {
			if (document.getElementById("taskTable").rows[i].cells[5].innerHTML == '<img src="checkedBox.png">') {
				return i;
			}
		}
	}

	function removeFromDatabase(num) {
		var db = firebase.database().ref('tasks');
		var toDelete = document.getElementById("taskTable").rows[num].cells[2].innerHTML;
		db.child(toDelete).remove();
	}

// From https://www.w3schools.com/howto/howto_js_sort_table.asp
	function sortTable() {
	  const PRIORITY = 0;
	  const PROJECT = 1;
	  const TASKNAME = 2;
	  const DUEDATE = 3;
	  const TIMEEST = 4;
	  var table, rows, switching, i, x, y, shouldSwitch;
	  table = document.getElementById("taskTable");
	  switching = true;
	  /*Make a loop that will continue until
	  no switching has been done:*/
	  while (switching) {
	    //start by saying: no switching is done:
	    switching = false;
	    rows = table.getElementsByTagName("TR");
	    /*Loop through all table rows (except the
	    first, which contains table headers):*/
	    for (i = 1; i < (rows.length - 1); i++) {
	      //start by saying there should be no switching:
	      shouldSwitch = false;
	      /*Get the two elements you want to compare,
	      one from current row and one from the next:*/
	      x = rows[i].getElementsByTagName("TD")[DUEDATE];
	      y = rows[i + 1].getElementsByTagName("TD")[DUEDATE];
	      //check if the two rows should switch place:
	      if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
	        //if so, mark as a switch and break the loop:
	        shouldSwitch= true;
	        break;
	      }
	    }
	    if (shouldSwitch) {
	      /*If a switch has been marked, make the switch
	      and mark that a switch has been done:*/
	      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
	      switching = true;
	    }
	  }
}

</script>
